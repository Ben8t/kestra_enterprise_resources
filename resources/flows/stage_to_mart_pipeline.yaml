id: stage_to_mart_pipeline
namespace: acme.company.data

tasks:
  - id: create_staging_layer_asset
    type: io.kestra.plugin.jdbc.duckdb.Query
    sql: |
      CREATE TABLE IF NOT EXISTS trips AS
      select VendorID, passenger_count, trip_distance from sample_data.nyc.taxi limit 10;
    assets:
      inputs:
        - id: sample_data.nyc.taxi
      outputs:
          - id: trips
            type: io.kestra.plugin.ee.assets.Table
            metadata:
              owner: DataSquadA
              model_layer: staging
            
  - id: mart_table
    type: io.kestra.plugin.jdbc.duckdb.Query
    sql: |
      CREATE TABLE IF NOT EXISTS avg_passenger_count AS
      SELECT AVG(passenger_count) AS avg_passenger_count FROM trips;
    assets:
      inputs:
          - id: trips
      outputs:
          - id: avg_passenger_count
            type: io.kestra.plugin.ee.assets.Table
            metadata:
              owner: DataSquadB
              model_layer: mart

pluginDefaults:
  - type: io.kestra.plugin.jdbc.duckdb
    values:
      url: "jdbc:duckdb:md:my_db?motherduck_token={{ secret('MOTHERDUCK_TOKEN') }}"
      fetchType: STORE